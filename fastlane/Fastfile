default_platform(:ios)
platform :ios do 
  lane :beta_release do |options|
    # 设置travis
    setup_travis
    # 设置munual
    codeSign()
    
    match(
      keychain_name: "ios-build.keychain",
      keychain_password: "0728"
    )
    # cocoapods
    cocoapods(
      clean_install: true,
      )
    # update_code_signing_settings(
    #   use_automatic_signing: false
    # )
    # update_project_provisioning(
    #   profile: "./profile/tapnow_adc.mobileprovision",
    #   build_configuration: "Release",
    #   code_signing_identity: "iPhone Distribution: Hao Zheng (F6CYAWT7QB)",
    #   certificate: "./profile/ios_distribution_zhenghao.cer"
    # )
    # 版本号设置
    increment_build_number(
      build_number: options[:buildnumber]
      )
    
    # 打包ipa文件
    buildapp(
      workspace: "travis.xcworkspace",
      configuration: "Release",
      scheme: "travis",
      export_method: "ad-hoc",
      output_name: options[:ipaname]
      )
    
    # 上传到蒲公英
    # pgyer(api_key: "xxx", user_key: "xxx", update_description: options[:message])
  end

  desc "build app"
  private_lane :buildapp do |options|
    gym(
      workspace: options[:workspace],
      configuration: options[:configuration],
      scheme: options[:scheme],
      clean: true,
      export_method: options[:export_method],
      output_directory: "./fastlane/package/",
      output_name: options[:output_name],
      sdk: "iphoneos"
      )
  end 
end


def codeSign()

  create_keychain(
    name: "ios-build.keychain",
    password: "0728",
    default_keychain: true,
    unlock: true,
    timeout: 3600,
    lock_when_sleeps: true
    )

  install_provisioning_profile(
    path: "./profile/tapnow_adc.mobileprovision"
    )

  import_certificate(
    certificate_path: "./profile/dis.p12",
    certificate_password: "0728",
    keychain_name: "ios_build.keychain",
    keychain_password: "0728"
  )

end 